# EEGCPM Configuration - MNE-BIDS Pipeline Equivalent
#
# This configuration replicates MNE-BIDS pipeline default preprocessing
# for EEG data, allowing direct comparison and systematic experimentation
# with parameter variations.
#
# Based on:
# - MNE-BIDS pipeline documentation
# - Common MNE-Python best practices
# - Published preprocessing workflows (Jas et al., 2017; Appelhoff et al., 2019)
#
# Use this as BASELINE, then create variants to test preprocessing effects
# on CPM prediction performance.

# ==============================================================================
# MONTAGE SETTING
# ==============================================================================
montage:
  enabled: true
  type: "standard_1020"  # MNE-BIDS uses standard montages
  # For HBN: Use custom montage
  file: "/Volumes/Work/data/hbn/docs/HydroCel 129.sfp"

# ==============================================================================
# BAD CHANNEL DETECTION & INTERPOLATION
# ==============================================================================
bad_channels:
  # MNE-BIDS uses automated bad channel detection
  auto_detect: true

  # MNE-BIDS DEFAULT: RANSAC via Autoreject
  # RANSAC is more robust than variance/correlation for large channel arrays
  # Requires montage to be set for spatial interpolation
  methods: ["ransac"]

  # RANSAC parameters (Autoreject defaults)
  ransac_sample_prop: 0.25    # Use 25% of channels for prediction
  ransac_corr_threshold: 0.75 # Correlation threshold for consensus

  # Alternative methods (for comparison):
  # methods: ["variance", "correlation"]  # Simpler but less robust
  # variance_threshold: 5.0
  # correlation_threshold: 0.4

  # Interpolation: ENABLED (standard practice)
  # CRITICAL: Always interpolate to maintain consistent channel counts
  # across subjects for source localization and CPM
  interpolate: true

  # Subject-level quality threshold (community standard: 20%)
  # Subjects exceeding this threshold flagged for exclusion
  # Interpolation becomes unreliable when >20% channels are bad
  max_bad_channel_percent: 20.0

  # Tiered system:
  #   < 10%: OK (high quality)
  #   10-20%: WARNING (acceptable, use with caution)
  #   > 20%: EXCLUDE (unreliable interpolation)

  manual_bads: []

# ==============================================================================
# ARTIFACT ANNOTATION
# ==============================================================================
artifact_detection:
  # MNE-BIDS annotates artifacts for later rejection during epoching
  enabled: true

  # Amplitude-based detection
  # Standard threshold: 100-150 µV for EEG
  amplitude_threshold: 0.00015  # 150 µV (conservative)

  # Gradient-based detection (rapid changes)
  gradient_threshold: 0.000075  # 75 µV/sample

  # Flatline detection
  flatline_duration: 5.0  # seconds

  # Muscle artifacts: typically disabled for resting-state
  muscle_threshold: null
  freq_muscle: [110, 140]

  min_duration: 0.1  # seconds

# ==============================================================================
# RE-REFERENCING
# ==============================================================================
reference:
  # MNE-BIDS DEFAULT: Average reference
  type: "average"

  # Use projection (reversible, recommended)
  projection: true

  # Exclude bad channels from average
  exclude_bads: true

  channels: null

# ==============================================================================
# RESAMPLING
# ==============================================================================
resample:
  # MNE-BIDS often resamples to reduce computational cost
  # Common target: 250 Hz or 500 Hz
  # DISABLE for initial equivalence testing
  enabled: false
  sfreq: 250

# ==============================================================================
# FILTERING
# ==============================================================================
filter:
  # MNE-BIDS DEFAULT FILTER SETTINGS (for EEG):
  # Highpass: 1.0 Hz (removes slow drifts, eye movements)
  # Lowpass: 40.0 Hz (keeps EEG range, removes muscle)

  l_freq: 1.0   # MNE-BIDS default (stricter than EEGCPM 0.5 Hz)
  h_freq: 40.0  # Same as EEGCPM

  # Notch filter: Usually disabled (bandpass sufficient)
  notch_freq: null

# ==============================================================================
# ICA (Independent Component Analysis)
# ==============================================================================
ica:
  # MNE-BIDS ENABLES ICA for artifact removal
  enabled: true

  # MNE-BIDS DEFAULT: Extended Infomax (more robust than infomax)
  # Extended-infomax is specified as method='infomax' with extended=True in MNE-Python
  # This config accepts "extended-infomax" which is mapped to infomax+extended internally
  method: "extended-infomax"

  # Number of components: auto (min(20, n_channels-1))
  n_components: null

  # Auto-detect artifact components (EOG, ECG)
  auto_detect_artifacts: true

  # Manual exclusions
  manual_exclude: []

  # ICLabel: MNE-BIDS may use this for automatic classification
  # Requires: pip install mne-icalabel
  use_iclabel: false
  iclabel_threshold: 0.8

# ==============================================================================
# ASR (Artifact Subspace Reconstruction)
# ==============================================================================
asr:
  # MNE-BIDS does NOT use ASR (not standard practice)
  enabled: false
  cutoff: 20.0
  train_duration: 60

# ==============================================================================
# SUMMARY: MNE-BIDS EQUIVALENT PIPELINE
# ==============================================================================
#
# Pipeline order:
# 1. Set montage ✓
# 2. Detect & interpolate bad channels ✓
# 3. Annotate artifacts ✓
# 4. Re-reference to average ✓
# 5. Resample (disabled for testing) ✓
# 6. Filter: 1.0-40 Hz ✓
# 7. ICA: extended-infomax ✓
# 8. ASR: disabled ✓
#
# KEY DIFFERENCES TO TEST:
# - l_freq: 0.5 Hz (EEGCPM current) vs 1.0 Hz (MNE-BIDS)
# - ICA method: "infomax" vs "extended-infomax"
# - Bad channel detection: variance/correlation vs RANSAC
#
# VARIANTS TO CREATE:
# - preprocessing_config_variants.yaml with different parameters
# - Compare CPM prediction performance across variants
