# EEGCPM Preprocessing Pipeline Configuration
#
# This configuration file defines all preprocessing steps for EEG data.
# Steps are executed in order: montage -> bad_channels -> artifacts ->
# reference -> resample -> filter -> ica
#
# All steps are optional and can be enabled/disabled individually.

# ==============================================================================
# MONTAGE SETTING
# ==============================================================================
montage:
  enabled: true
  type: "standard_1020"  # MNE standard montage (fallback)
  # HBN-specific: Use HydroCel 129 montage for accurate source localization
  file: "/Volumes/Work/data/hbn/docs/HydroCel 129.sfp"  # Custom montage with E1-E128 positions

# ==============================================================================
# BAD CHANNEL DETECTION & INTERPOLATION
# ==============================================================================
bad_channels:
  # Automatic detection
  auto_detect: true
  methods: ["variance", "correlation"]  # Available: variance, correlation, ransac, deviation

  # Method-specific thresholds
  variance_threshold: 5.0      # SD from median variance
  correlation_threshold: 0.4   # Minimum correlation with neighbors
  ransac_sample_prop: 0.25     # Proportion for RANSAC sampling
  ransac_corr_threshold: 0.75  # RANSAC correlation threshold
  deviation_threshold: 5.0     # SD from robust mean

  # Manual bad channels (always marked as bad)
  manual_bads: []  # e.g., ["Fp1", "Fp2"]

  # Interpolation
  interpolate: true  # Use spherical spline interpolation

# ==============================================================================
# ARTIFACT ANNOTATION (marks bad segments, doesn't remove data)
# ==============================================================================
artifact_detection:
  enabled: true

  # Amplitude-based detection (voltage extremes)
  amplitude_threshold: 0.00015  # 150 µV (can use dict for per-type: {eeg: 0.00015, eog: 0.00025})

  # Gradient-based detection (rapid changes)
  gradient_threshold: 0.000075  # 75 µV per sample

  # Flatline detection (disconnected electrodes)
  flatline_duration: 5.0       # seconds

  # Muscle artifact detection (high-frequency bursts)
  muscle_threshold: null       # Set to 4.0 to enable (z-score threshold)
  freq_muscle: [110, 140]      # Frequency range for muscle detection (Hz)

  # Minimum annotation duration
  min_duration: 0.1            # seconds

# ==============================================================================
# RE-REFERENCING
# ==============================================================================
reference:
  # Reference types: average, mastoid, custom, robust_average, original
  type: "average"

  # For mastoid or custom reference, specify channel(s)
  # channels: "Cz"              # Single channel
  # channels: ["TP9", "TP10"]   # Linked mastoids
  channels: null

  # Use projection (reversible) vs direct re-reference
  projection: true

  # Exclude bad channels from average
  exclude_bads: true

# ==============================================================================
# RESAMPLING
# ==============================================================================
resample:
  enabled: false
  sfreq: 250  # Target sampling rate (Hz)

# ==============================================================================
# FILTERING
# ==============================================================================
filter:
  # Bandpass filter
  l_freq: 0.5   # Highpass cutoff (Hz)
  h_freq: 40.0  # Lowpass cutoff (Hz)

  # Notch filter for line noise
  notch_freq: null  # null to disable, or [50, 100] for 50 Hz + harmonic

# ==============================================================================
# ICA (Independent Component Analysis)
# ==============================================================================
ica:
  enabled: false  # Temporarily disabled for testing

  # ICA method: infomax, fastica, picard
  method: "infomax"

  # Number of components (null = auto: min(20, n_channels-1))
  n_components: null

  # Automatic artifact detection
  auto_detect_artifacts: true  # Detect EOG/ECG components automatically

  # Manual component exclusion (by index)
  manual_exclude: []  # e.g., [0, 1, 5]

  # Advanced: Use ICLabel for automatic component classification
  # Requires: pip install mne-icalabel
  use_iclabel: false
  iclabel_threshold: 0.8  # Confidence threshold for artifact components

# ==============================================================================
# ASR (Artifact Subspace Reconstruction) - EXPERIMENTAL
# ==============================================================================
asr:
  enabled: false
  cutoff: 20.0         # Rejection threshold (higher = more lenient)
  train_duration: 60   # Duration of clean data for training (seconds)

# ==============================================================================
# PREPROCESSING PIPELINE ORDER
# ==============================================================================
# Steps are executed in this order:
# 1. Set montage
# 2. Detect & interpolate bad channels
# 3. Annotate artifacts
# 4. Re-reference
# 5. Resample (if enabled)
# 6. Filter (bandpass + notch)
# 7. ICA
# 8. ASR (if enabled)

# ==============================================================================
# EXAMPLE CONFIGURATIONS
# ==============================================================================

# MINIMAL (fastest, least processing)
# filter:
#   l_freq: 1.0
#   h_freq: 40.0
# reference:
#   type: "average"
# ica:
#   enabled: false

# STANDARD (recommended for most analyses)
# bad_channels:
#   auto_detect: true
#   methods: ["variance", "correlation"]
# artifact_detection:
#   enabled: true
#   amplitude_threshold: 150e-6
# reference:
#   type: "average"
# filter:
#   l_freq: 0.5
#   h_freq: 40.0
# ica:
#   enabled: true
#   method: "infomax"

# AGGRESSIVE (maximum artifact removal)
# bad_channels:
#   auto_detect: true
#   methods: ["variance", "correlation", "ransac", "deviation"]
#   variance_threshold: 3.0
# artifact_detection:
#   enabled: true
#   amplitude_threshold: 100e-6
#   gradient_threshold: 50e-6
#   flatline_duration: 3.0
#   muscle_threshold: 3.0
# reference:
#   type: "robust_average"
# filter:
#   l_freq: 1.0
#   h_freq: 40.0
#   notch_freq: [50, 100]
# ica:
#   enabled: true
#   use_iclabel: true
# asr:
#   enabled: true
